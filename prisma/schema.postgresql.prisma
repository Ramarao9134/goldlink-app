// PostgreSQL version of schema - use this for production
// Copy this to schema.prisma before deploying to production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  OWNER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SettlementStatus {
  ACTIVE
  CLOSED
}

enum PaymentStatus {
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentGateway {
  RAZORPAY
  STRIPE
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  phone         String?
  role          UserRole
  hashedPassword String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  applicationsAsCustomer Application[] @relation("CustomerApplications")
  applicationsAsOwner    Application[] @relation("OwnerApplications")
  settlementsAsCustomer  Settlement[]  @relation("CustomerSettlements")
  auditLogs             AuditLog[]

  @@index([email])
  @@index([role])
}

model GoldRate {
  id            String   @id @default(cuid())
  karat         String   // "22K" or "24K"
  pricePerGram  Float
  source        String?
  fetchedAt     DateTime @default(now())

  @@index([karat, fetchedAt])
}

model Application {
  id            String            @id @default(cuid())
  customerId    String
  ownerId       String
  karat         String            // "22K" or "24K"
  weightGrams   Float
  photos        String[]          // Array of image URLs (PostgreSQL supports arrays)
  notes         String?
  status        ApplicationStatus @default(PENDING)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  customer      User              @relation("CustomerApplications", fields: [customerId], references: [id])
  owner         User              @relation("OwnerApplications", fields: [ownerId], references: [id])
  settlement    Settlement?

  @@index([customerId])
  @@index([ownerId])
  @@index([status])
}

model Settlement {
  id                    String           @id @default(cuid())
  applicationId         String           @unique
  customerId            String
  principalAmount       Float
  interestRateMonthlyPct Float
  startDate             DateTime         @default(now())
  nextDueDate           DateTime
  status                SettlementStatus @default(ACTIVE)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  // Relations
  application           Application      @relation(fields: [applicationId], references: [id])
  customer              User             @relation("CustomerSettlements", fields: [customerId], references: [id])
  payments              Payment[]

  @@index([customerId])
  @@index([status])
  @@index([nextDueDate])
}

model Payment {
  id              String         @id @default(cuid())
  settlementId    String
  amount          Float
  gateway         PaymentGateway
  gatewayPaymentId String?
  status          PaymentStatus
  paidAt          DateTime?
  receiptUrl      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  settlement      Settlement     @relation(fields: [settlementId], references: [id])

  @@index([settlementId])
  @@index([status])
  @@index([gatewayPaymentId])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  action      String
  entityType  String
  entityId    String
  meta        Json?    // PostgreSQL supports JSON type
  at          DateTime @default(now())

  // Relations
  actor       User     @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([at])
}

